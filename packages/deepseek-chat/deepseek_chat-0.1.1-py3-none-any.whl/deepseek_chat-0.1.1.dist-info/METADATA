Metadata-Version: 2.4
Name: deepseek_chat
Version: 0.1.1
Summary: Thin DeepSeek Chat wrapper with Mongo-backed conversation tree.
Author-email: bonecard <guxiaowa77@gmail.com>
License: MIT
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: requests>=2.31
Requires-Dist: pymongo>=4.6
Requires-Dist: pydantic>=2.7
Requires-Dist: pydantic-settings>=2.0
Requires-Dist: tiktoken>=0.6
Provides-Extra: dev
Requires-Dist: pytest>=8; extra == "dev"
Requires-Dist: ruff; extra == "dev"
Dynamic: license-file

[![PyPI version](https://img.shields.io/pypi/v/deepseek-chat.svg)](https://pypi.org/project/deepseek-chat/)
[![Downloads](https://static.pepy.tech/badge/deepseek-chat/)](https://pepy.tech/project/deepseek-chat/)

# ğŸ›°ï¸ deepseek-chat-sdk

**A thin, battle-tested Python wrapper around the DeepSeek `/chat/completions` API**  
with *built-in conversation-tree persistence*.

- **Drop-in call style** â€“ mirrors `openai-python` (`messages=[â€¦]`)  
- **Two storage back-ends**    
  *MongoDB* (default) **or** ultra-light *JSON file* â€“ same API, switch in one flag  
- **Tree-structured memory** â€“ each reply is a **node**; fork, branch & query whole tree  
- **Token-budget guard** â€“ automatic context trimming (or raise)  
- **100 % sync code** â€“ keep dependencies minimal, trivially pluggable into any code-base  

```text
pip install deepseek_chat          # from PyPI (or pip install -e .)
export DEEPSEEK_API_KEY=sk-...
````

---

## â­ Quick Start

```python
from deepseek_chat import create_session, continue_chat, get_tree

# --- root turn --------------------------------------------------------
answer, sess_id, root_id = create_session(
    system_prompt="ä½ å¥½ï¼Œæˆ‘æ˜¯åŠ©æ‰‹ã€‚",
    question="å¸®æˆ‘æ¨èä¸€éƒ¨ç”µå½±ã€‚",
    api_key="sk-...",                     # or rely on $DEEPSEEK_API_KEY
)
print(answer)

# --- branch off the same parent --------------------------------------
continue_chat(session_id=sess_id, parent_node_id=root_id,
              question="æœ‰æ²¡æœ‰åŒç±»å‹ä½†è¯„åˆ†æ›´é«˜çš„ï¼Ÿ")

# --- show the whole tree --------------------------------------------
print(get_tree(sess_id))
```

### Switch to local file storage (no Mongo)

```python
answer, sid, nid = create_session(
    system_prompt="ä½ å¥½ï¼",
    question="ä»Šå¤©æ­å·å¤©æ°”å¦‚ä½•ï¼Ÿ",
    api_key="sk-...",
    store_backend="file",              # â† key flag
    json_path="./history.json",        # optional; default ~/.deepseek_chat/history.json
)
```

### Custom Mongo URI (user/pass, replica set â€¦)

```python
import os
os.environ["DEEPSEEK_API_KEY"] = "sk-..."
answer, sid, nid = create_session(
    system_prompt="You are helpful.",
    question="Tell me a joke.",
    mongo_uri="mongodb://dbUser:dbPwd@mongo-1:27017,mongo-2:27017/?replicaSet=rs0",
)
```

---

## ğŸ”§ Installation

```bash
# bare minimum
pip install deepseek_chat

# dev / tests / ruff
pip install "deepseek_chat"
pytest -q
```

| Dependency | Used for       | Optional?                             |
| ---------- | -------------- | ------------------------------------- |
| `requests` | REST calls     | âŒ                                     |
| `pymongo`  | Mongo back-end | âœ… (not imported if you choose `file`) |
| `tiktoken` | token counting | âœ… (falls back to word count)          |

---

## ğŸ—ºï¸ API Surface

### Functional helpers (one-liners)

| function                                                 | returns                         | must pass                                  |
| -------------------------------------------------------- | ------------------------------- | ------------------------------------------ |
| `create_session(system_prompt, question, â€¦)`             | `(answer, session_id, node_id)` | `system_prompt`, `question`                |
| `continue_chat(session_id, parent_node_id, question, â€¦)` | `(answer, new_node_id)`         | `session_id`, `parent_node_id`, `question` |
| `get_tree(session_id, â€¦)`                                | nested `dict`                   | `session_id`                               |

All take the same optional kwargs:

```text
api_key        DeepSeek API key (fallback $DEEPSEEK_API_KEY)
base_url       custom gateway (fallback $DEEPSEEK_BASE_URL)
model          deepseek-chat / deepseek-coder / â€¦
store_backend  "mongo" | "file"   (default "mongo")
mongo_uri      mongodb connection string
json_path      path for file store
```

### Class-level control

Need multiple clients or stores side-by-side? Use the OOP facade:

```python
from deepseek_chat import ChatService, DeepSeekClient, FileStore

svc = ChatService(
    client=DeepSeekClient(api_key="sk-..."),
    store=FileStore("/tmp/ds_history.json"),
)

ans, sid, nid = svc.create_session(
    system_prompt="You are GPT-5",
    question="What's new in 2025?",
)
```

---

## âš™ï¸ Configuration matrix

| config source               | DeepSeek                                                                              | Mongo                  | File         |
| --------------------------- | ------------------------------------------------------------------------------------- | ---------------------- | ------------ |
| ENV var (default singleton) | `DEEPSEEK_API_KEY` `DEEPSEEK_BASE_URL`                                                | `MONGO_URI` `MONGO_DB` | â€”            |
| per-call kwargs             | `api_key=` `base_url=`                                                                | `mongo_uri=`           | `json_path=` |
| programmatic                | build your own `DeepSeekClient` + `ChatStore`/`FileStore` and pass into `ChatService` |                        |              |

---

## ğŸ“š Advanced features

### JSON Output & Function Calling

Simply forward the native OpenAI-style params:

```python
client = DeepSeekClient(api_key="sk-...")

resp = client.chat(
    messages=[...],
    response_format={"type": "json_object"},
)

resp_tool = client.chat(
    messages=[...],
    tools=[{ "type": "function", "function": {...} }],
)
```

The higher-level helpers (`create_session`/`continue_chat`) accept **any extra
kwargs** and pass them straight to `DeepSeekClient.chat()`.

### Token-budget enforcement

`ensure_token_budget()` truncates eldest user/assistant pairs once total tokens
exceed the limit (default 32 k). Raise `TokenLimitExceeded` if **only** the
system prompt already exceeds the model context.

Set a custom limit:

```bash
export TOKEN_LIMIT=16000
```

---

## ğŸ› ï¸ Project layout

```
deepseek_chat/
â”œâ”€â”€ client.py        # DeepSeek REST wrapper
â”œâ”€â”€ service.py       # high-level orchestration
â”œâ”€â”€ store.py         # Mongo persistence
â”œâ”€â”€ filestore.py     # JSON persistence
â”œâ”€â”€ utils.py         # token helpers
â””â”€â”€ __init__.py      # facade + functional helpers
```

Unit tests live under `tests/`, demo scripts under `examples/`.

---

## ğŸª„ Roadmap

* async variant (`httpx.AsyncClient`, `motor`)
* automatic summarisation for ultra-long histories
* plug-in hooks (on\_new\_message, on\_error)

Contributions welcome â€“ just open an issue or PR.

---


