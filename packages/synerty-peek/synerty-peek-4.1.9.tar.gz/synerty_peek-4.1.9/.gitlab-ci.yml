include :
    -   local : '.gitlab-release-branch.yml'

variables :
    RELEASE_VER : ${PKG_TAG_VERSION}
    GIT_CLONE_PATH : $CI_BUILDS_DIR/peek
    PEEK_NODE_VERSION : v7.1.0
    BUILD : build
    PKG_ENTERPRISE_LINUX : tmp_pkg_enterprise_linux
    PKG_COMMUNITY_LINUX : tmp_pkg_community_linux
    PKG_ENTERPRISE_MACOS : tmp_pkg_enterprise_macos
    PKG_COMMUNITY_MACOS : tmp_pkg_community_macos
    NON_RELEASE_VER : 0.0.0+b${CI_PIPELINE_ID}
    PINNED_DEPS_PY_FILE_CENTOS : ${CI_PROJECT_DIR}/gitlab/${RELEASE_BRANCH}/requirements/release_pinned_peek_requirements.txt
    PINNED_DEPS_PY_FILE_MACOS : ${CI_PROJECT_DIR}/gitlab/${RELEASE_BRANCH}/macos/pinned-deps-py

stages :
    - docs
    - fetch
    - publish
    - package
    - archive
    - upload


build_html_docs :
    artifacts :
        paths :
            - synerty-peek-html
        expire_in : 1 day
    allow_failure : false
    image : nexus.synerty.com:5000/peek-debian-doc:${RELEASE_BRANCH}
    only :
        - pushes
        - merge_requests
    script :
        - uname -a
        - which python || true
        - python --version
        - export PIP_INDEX=http://${NEXUS_USER}:${NEXUS_PASSWORD}@${NEXUS_URL}/repository/pypi-all/pypi
        - export PIP_INDEX_URL=http://${NEXUS_USER}:${NEXUS_PASSWORD}@${NEXUS_URL}/repository/pypi-all/simple
        - export PIP_TRUSTED_HOST=${NEXUS_URL}
        - pip install -r docs/rtfd_requirements.txt
        - (cd docs && bash build_html_docs.sh)
        - mv docs/doc_dist synerty-peek-html
    stage : docs
    tags :
        - linux

build_latex_docs :
    artifacts :
        paths :
            - synerty-peek.pdf
        expire_in : 1 day
    allow_failure : false
    image : nexus.synerty.com:5000/peek-debian-doc:${RELEASE_BRANCH}
    only :
        - pushes
        - merge_requests
    script :
        - uname -a
        - which python || true
        - python --version
        - export PIP_INDEX=http://${NEXUS_USER}:${NEXUS_PASSWORD}@${NEXUS_URL}/repository/pypi-all/pypi
        - export PIP_INDEX_URL=http://${NEXUS_USER}:${NEXUS_PASSWORD}@${NEXUS_URL}/repository/pypi-all/simple
        - export PIP_TRUSTED_HOST=${NEXUS_URL}
        - pip install -r docs/rtfd_requirements.txt
        - (cd docs && bash build_pdf_doc.sh)
        - mv docs/doc_dist_latex/SynertyPeek.pdf synerty-peek.pdf
    stage : docs
    tags :
        - linux

# ##########################################################################################
# # LINUX Builds

git_clone_community :
    allow_failure : false
    artifacts :
        paths :
            - ${GIT_CLONE_PATH}/cloned_community_repos
        expire_in : 1 day
    image : nexus.synerty.com:5000/peek-centos-build:${RELEASE_BRANCH}
    only :
        - web
        - triggers
        - api
    script :
        - uname -a
        - which python || true
        - python --version
        - ./gitlab/scripts/git_clone.sh community ${GIT_CLONE_PATH}/cloned_community_repos
            ${GIT_USER} ${GIT_PASSWORD}
            ${CI_COMMIT_REF_NAME} ${CI_PROJECT_NAMESPACE} ${RELEASE_BRANCH}
    stage : fetch
    tags :
        - linux

git_clone_enterprise :
    allow_failure : false
    artifacts :
        paths :
            - ${GIT_CLONE_PATH}/cloned_enterprise_repos
        expire_in : 1 day
    image : nexus.synerty.com:5000/peek-centos-build:${RELEASE_BRANCH}
    only :
        - web
        - triggers
        - api
    script :
        - uname -a
        - which python || true
        - python --version
        - ./gitlab/scripts/git_clone.sh enterprise ${GIT_CLONE_PATH}/cloned_enterprise_repos
            ${GIT_USER} ${GIT_PASSWORD}
            ${CI_COMMIT_REF_NAME} ${CI_PROJECT_NAMESPACE} ${RELEASE_BRANCH}
    stage : fetch
    tags :
        - linux

publish_community :
    dependencies :
        - git_clone_community
    allow_failure : false
    artifacts :
        paths :
            - ${GIT_CLONE_PATH}/community_packages
        expire_in : 1 day
    image : nexus.synerty.com:5000/peek-centos-build:${RELEASE_BRANCH}
    only :
        - web
        - triggers
        - api
    stage : publish
    script :
        - uname -a
        - which python || true
        - python --version
        - export GITHUB_PUSH=0
        - pip install build
        - ./publish_community.sh ${RELEASE_VER:-${NON_RELEASE_VER}} ${GIT_CLONE_PATH}/cloned_community_repos
        - mkdir -p ${GIT_CLONE_PATH}/community_packages
        - mv ${GIT_CLONE_PATH}/cloned_community_repos/*/dist/* ${GIT_CLONE_PATH}/community_packages
    tags :
        - linux


publish_enterprise :
    dependencies :
        - git_clone_community
        - git_clone_enterprise
    allow_failure : false
    artifacts :
        paths :
            - ${GIT_CLONE_PATH}/enterprise_packages
        expire_in : 1 day
    image : nexus.synerty.com:5000/peek-centos-build:${RELEASE_BRANCH}
    only :
        - web
        - triggers
        - api
    stage : publish
    script :
        - uname -a
        - which python || true
        - python --version
        - export GITHUB_PUSH=0
        - pip install build
        - ./publish_enterprise.sh ${RELEASE_VER:-${NON_RELEASE_VER}} ${GIT_CLONE_PATH}/cloned_enterprise_repos
        - mkdir -p ${GIT_CLONE_PATH}/enterprise_packages
        - mv ${GIT_CLONE_PATH}/cloned_enterprise_repos/*/dist/* ${GIT_CLONE_PATH}/enterprise_packages
    tags :
        - linux

package_community_linux :
    dependencies :
        - git_clone_community
        - publish_community
    allow_failure : false
    artifacts :
        paths :
            - ${GIT_CLONE_PATH}/${PKG_COMMUNITY_LINUX}
        expire_in : 1 day
    image : nexus.synerty.com:5000/peek-centos-build:${RELEASE_BRANCH}
    only :
        - web
        - triggers
        - api
    stage : package
    script :
        - uname -a
        - which python || true
        - python --version
        - echo "registry=http://${NEXUS_URL}/repository/npm-all/" > ~/.npmrc
        - _nexus_auth_encoded=$(echo -n "${NEXUS_USER}:${NEXUS_PASSWORD}" | openssl base64)
        - echo "//${NEXUS_URL}/repository/npm-all/:_auth=${_nexus_auth_encoded}" >> ~/.npmrc
        - export NG_CLI_ANALYTICS=ci
        - export PIP_INDEX=http://${NEXUS_USER}:${NEXUS_PASSWORD}@${NEXUS_URL}/repository/pypi-proxy/pypi
        - export PIP_INDEX_URL=http://${NEXUS_USER}:${NEXUS_PASSWORD}@${NEXUS_URL}/repository/pypi-proxy/simple
        - export PIP_TRUSTED_HOST=${NEXUS_URL}
        - export NG_CLI_ANALYTICS=ci
        - mkdir -p ${GIT_CLONE_PATH}/${PKG_COMMUNITY_LINUX}
        - ./scripts/linux/package_linux.sh -r community ${RELEASE_VER:-${NON_RELEASE_VER}}
            ${GIT_CLONE_PATH}/cloned_community_repos
            ${GIT_CLONE_PATH}/community_packages
            ${GIT_CLONE_PATH}/${PKG_COMMUNITY_LINUX}
            ${PINNED_DEPS_PY_FILE_CENTOS}
    tags :
        - linux

package_enterprise_linux :
    dependencies :
        - publish_community
        - publish_enterprise
    allow_failure : false
    artifacts :
        paths :
            - ${GIT_CLONE_PATH}/${PKG_ENTERPRISE_LINUX}/
        expire_in : 1 day
    image : nexus.synerty.com:5000/peek-centos-build:${RELEASE_BRANCH}
    only :
        - web
        - triggers
        - api
    stage : package
    script :
        - uname -a
        - which python || true
        - python --version
        - mkdir -p ~/.config/pip
        - mkdir -p ${GIT_CLONE_PATH}/${PKG_ENTERPRISE_LINUX}
        - export PIP_INDEX=http://${NEXUS_USER}:${NEXUS_PASSWORD}@${NEXUS_URL}/repository/pypi-proxy/pypi
        - export PIP_INDEX_URL=http://${NEXUS_USER}:${NEXUS_PASSWORD}@${NEXUS_URL}/repository/pypi-proxy/simple
        - export PIP_TRUSTED_HOST=${NEXUS_URL}
        - ./scripts/linux/package_linux.sh -r enterprise ${RELEASE_VER:-${NON_RELEASE_VER}}
            ${GIT_CLONE_PATH}/enterprise_packages
            ${GIT_CLONE_PATH}/community_packages
            ${GIT_CLONE_PATH}/${PKG_ENTERPRISE_LINUX}
            ${PINNED_DEPS_PY_FILE_CENTOS}
    tags :
        - linux

archive_release_linux :
    dependencies :
        - package_enterprise_linux
        - package_community_linux
    allow_failure : false
    artifacts :
        paths :
            - ${GIT_CLONE_PATH}/peek_release_linux_${RELEASE_VER:-${NON_RELEASE_VER}}.tar
        expire_in : 1 day
    image : nexus.synerty.com:5000/peek-centos-build:${RELEASE_BRANCH}
    only :
        - web
        - triggers
        - api
    stage : archive
    script :
        - uname -a
        - which python || true
        - python --version
        - mkdir -p ~/.config/pip
        - mkdir -p ${GIT_CLONE_PATH}/peek_release_linux_${RELEASE_VER:-${NON_RELEASE_VER}}
        - cp ./scripts/linux/deploy_release_linux.sh
            ${GIT_CLONE_PATH}/peek_release_linux_${RELEASE_VER:-${NON_RELEASE_VER}}
        - mv $GIT_CLONE_PATH/${PKG_COMMUNITY_LINUX}/peek_community_linux_${RELEASE_VER:-${NON_RELEASE_VER}}.tar.bz2
            ${GIT_CLONE_PATH}/peek_release_linux_${RELEASE_VER:-${NON_RELEASE_VER}}
        - mv $GIT_CLONE_PATH/${PKG_ENTERPRISE_LINUX}/peek_enterprise_linux_${RELEASE_VER:-${NON_RELEASE_VER}}.tar.bz2
            ${GIT_CLONE_PATH}/peek_release_linux_${RELEASE_VER:-${NON_RELEASE_VER}}
        - cd ${GIT_CLONE_PATH}
            && tar cvf peek_release_linux_${RELEASE_VER:-${NON_RELEASE_VER}}.tar
            peek_release_linux_${RELEASE_VER:-${NON_RELEASE_VER}}
        - rm -rf ${GIT_CLONE_PATH}/peek_release_linux_${RELEASE_VER:-${NON_RELEASE_VER}}
    tags :
        - linux

upload_tagged_to_dropbox_linux:
    dependencies:
        - archive_release_linux
    allow_failure: false
    image: nexus.synerty.com:5000/peek-centos-build:${RELEASE_BRANCH}
    rules:
        - if: '$PKG_TAG_VERSION == null'
          when: never
        - if: '$CI_PIPELINE_SOURCE == "web"'
        - if: '$CI_PIPELINE_SOURCE == "triggers"'
        - if: '$CI_PIPELINE_SOURCE == "api"'
    script:
        - curl --version
        - curl -v
            --upload-file $GIT_CLONE_PATH/peek_release_linux_${RELEASE_VER:-${NON_RELEASE_VER}}.tar
            http://devo1dbx1.devo1.synerty.com/peek_synerty/
    stage : upload
    tags :
        - linux

upload_master_to_dropbox_linux:
    dependencies:
        - archive_release_linux
    allow_failure: false
    image: nexus.synerty.com:5000/peek-centos-build:${RELEASE_BRANCH}
    rules:
        - if: '$CI_COMMIT_REF_NAME != $RELEASE_BRANCH'
          when: never
        - if: '$CI_PIPELINE_SOURCE == "web"'
        - if: '$CI_PIPELINE_SOURCE == "triggers"'
        - if: '$CI_PIPELINE_SOURCE == "api"'
    script:
        - curl --version
        - cd $GIT_CLONE_PATH &&
            mv peek_release_linux_${RELEASE_VER:-${NON_RELEASE_VER}}.tar peek_release_linux_${RELEASE_BRANCH}.tar
        - curl -v
            --upload-file $GIT_CLONE_PATH/peek_release_linux_${RELEASE_BRANCH}.tar
            http://devo1dbx1.devo1.synerty.com/peek_synerty/
    stage: upload
    tags:
        - linux
