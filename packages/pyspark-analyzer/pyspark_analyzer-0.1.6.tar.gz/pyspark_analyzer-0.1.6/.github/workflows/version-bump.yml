name: Version Bump

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Bump type (patch, minor, major)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Python and uv
      uses: ./.github/actions/setup-python-uv
      with:
        python-version: "3.11"

    - name: Install bump2version
      run: |
        uv pip install bump2version

    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Get current version
      id: current_version
      run: |
        CURRENT_VERSION=$(grep 'current_version' .bumpversion.cfg | cut -d '=' -f2 | tr -d ' ')
        echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

    - name: Bump version
      run: |
        uv run bump2version ${{ github.event.inputs.bump_type }}

    - name: Get new version
      id: new_version
      run: |
        NEW_VERSION=$(grep 'current_version' .bumpversion.cfg | cut -d '=' -f2 | tr -d ' ')
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "Bump version: ${{ steps.current_version.outputs.version }} → ${{ steps.new_version.outputs.version }}"
        title: "Bump version: ${{ steps.current_version.outputs.version }} → ${{ steps.new_version.outputs.version }}"
        body: |
          ## Version Bump

          This PR bumps the version from `${{ steps.current_version.outputs.version }}` to `${{ steps.new_version.outputs.version }}`.

          ### Type of change
          - **Bump type**: ${{ github.event.inputs.bump_type }}

          ### Checklist
          - [ ] Version updated in `pyproject.toml`
          - [ ] Version updated in `pyspark_analyzer/__init__.py`
          - [ ] `.bumpversion.cfg` updated with new version

          ### Next steps
          1. Review the changes
          2. Merge this PR
          3. Create a new release with tag `v${{ steps.new_version.outputs.version }}`
        branch: version-bump-${{ steps.new_version.outputs.version }}
        delete-branch: true
