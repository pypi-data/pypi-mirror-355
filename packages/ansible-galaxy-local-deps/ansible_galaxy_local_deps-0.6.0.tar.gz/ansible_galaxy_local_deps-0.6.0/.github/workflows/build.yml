---
name: publish to (test.)pypi.org

on: push

jobs:
  test-build-publish:
    name: test, build and perhaps publish
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: checkout
        uses: actions/checkout@v4
      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v6
      - name: Lint
        run: uvx pre-commit run --all-files
      - name: Run tests
        run: uv run --frozen pytest tests
      - name: Build
        run: uv build
      - name: deploy to test.pypi.org
        if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        run: |
          uv publish \
            --publish-url https://test.pypi.org/legacy/ \
            --trusted-publishing always
      - name: deploy to pypi.org
        if: startsWith(github.ref, 'refs/tags')
        run: |
          uv publish \
            --trusted-publishing always
